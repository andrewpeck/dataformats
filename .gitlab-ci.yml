stages:
    - build

full:

  stage: build
  
  image: rootproject/root-conda

  script:
    - apt-get install -y zip
    - echo $CI_USER_PASSWORD | kinit $CI_USER@CERN.CH
    - export SRC="l0mdt_buses.csv"
    - git pull origin $CI_COMMIT_REF_NAME
    - git checkout $CI_COMMIT_REF_NAME
    - wget --output-document=$SRC "https://docs.google.com/spreadsheets/d/e/2PACX-1vSylQoq9qcxKz2dhXTtZpDkz00jicsuqYw_u6hopU_zs0gtBy5pBBD10hlvqPQ6ShLH5MP3eNKenzAO/pub?gid=1745105770&single=true&output=csv"
    - export REPO=`echo $CI_PROJECT_URL | sed -e s#https://##`
    - git remote set-url origin https://${CI_USER}:${CI_PUSH_TOKEN}@$REPO.git
    - git config user.email ${CI_EMAIL}
    - git config user.name ${CI_USER}
    - git add $SRC
    - git commit -m "CSV updated $(date +'%Y-%m-%d %H:%M:%S')" 
        && git push origin $CI_COMMIT_REF_NAME
        && exit 0
        || true
    - test -z $(git tag -l "done-$CI_COMMIT_SHORT_SHA") ||  exit 0
    - mkdir -p output
    - python l0mdt_dataFormat.py -i l0mdt_buses.csv -r "$CI_COMMIT_SHA" -o output
    - git tag done-$CI_COMMIT_SHORT_SHA
    - git push origin done-$CI_COMMIT_SHORT_SHA
    - zip output -r output
    - python tools/create_release.py
 
  except:
    refs:
      - /^done-.*$/
    changes:
      - README.md


